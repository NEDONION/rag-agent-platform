# ================================
# Zeabur 部署配置文件
# ================================
# 使用说明：
# 1. 在 Zeabur Dashboard 中创建新项目
# 2. 连接 GitHub 仓库
# 3. Zeabur 会自动检测并部署
# ================================

services:
  # ================================
  # 后端服务
  # ================================
  backend:
    type: dockerfile
    dockerfile: ./Dockerfile
    ports:
      - 8088
    env:
      # 服务器配置
      SERVER_PORT: 8088

      # 数据库配置（Zeabur 会自动注入）
      DB_HOST: ${POSTGRES_HOST}
      DB_PORT: ${POSTGRES_PORT}
      DB_NAME: ${POSTGRES_DATABASE}
      DB_USER: ${POSTGRES_USERNAME}
      DB_PASSWORD: ${POSTGRES_PASSWORD}

      # 向量数据库
      VECTOR_DB_HOST: ${POSTGRES_HOST}
      VECTOR_DB_PORT: ${POSTGRES_PORT}
      VECTOR_DB_NAME: ${POSTGRES_DATABASE}
      VECTOR_DB_USER: ${POSTGRES_USERNAME}
      VECTOR_DB_PASSWORD: ${POSTGRES_PASSWORD}

      # RabbitMQ（使用外部服务）
      RABBITMQ_HOST: ${RABBITMQ_HOST}
      RABBITMQ_PORT: ${RABBITMQ_PORT}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}

      # S3 对象存储
      S3_SECRET_ID: ${S3_SECRET_ID}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_REGION: ${S3_REGION}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME}
      S3_DOMAIN: ${S3_DOMAIN}

      # AI 模型
      SILICONFLOW_API_KEY: ${SILICONFLOW_API_KEY}
      SILICONFLOW_API_URL_RERANK: https://api.siliconflow.com/v1/rerank
      SILICONFLOW_MODEL_RERANK_MODEL: Qwen/Qwen3-Reranker-4B

      # 邮件配置
      MAIL_SMTP_HOST: ${MAIL_SMTP_HOST}
      MAIL_SMTP_PORT: ${MAIL_SMTP_PORT}
      MAIL_SMTP_USERNAME: ${MAIL_SMTP_USERNAME}
      MAIL_SMTP_PASSWORD: ${MAIL_SMTP_PASSWORD}

      # JVM 配置
      JAVA_OPTS: -Xms1g -Xmx2g -XX:+UseG1GC

      # 禁用容器管理功能
      DOCKER_ENABLED: false

    healthcheck:
      path: /api/actuator/health
      port: 8088

    resources:
      # 根据 Zeabur 订阅计划调整
      requests:
        cpu: 1000m      # 1 CPU
        memory: 2Gi     # 2GB RAM
      limits:
        cpu: 2000m      # 2 CPU
        memory: 4Gi     # 4GB RAM

  # ================================
  # 前端服务
  # ================================
  frontend:
    type: dockerfile
    dockerfile: ./Dockerfile
    context: ./frontend
    ports:
      - 3000
    env:
      # 后端 API 地址（Zeabur 会自动生成域名）
      NEXT_PUBLIC_API_URL: https://${BACKEND_DOMAIN}/api
      NEXT_PUBLIC_WS_URL: wss://${BACKEND_DOMAIN}/api
      NODE_ENV: production

    resources:
      requests:
        cpu: 500m       # 0.5 CPU
        memory: 1Gi     # 1GB RAM
      limits:
        cpu: 1000m      # 1 CPU
        memory: 2Gi     # 2GB RAM

  # ================================
  # PostgreSQL 数据库
  # ================================
  postgres:
    type: prebuilt
    service: postgresql
    version: "16"

    # 数据库配置
    config:
      database: agentx
      username: agentx_user

    # 资源配置
    resources:
      requests:
        memory: 1Gi
        storage: 10Gi
      limits:
        memory: 2Gi
        storage: 20Gi

    # 初始化脚本
    initdb:
      - CREATE EXTENSION IF NOT EXISTS vector;
      - CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

# ================================
# 域名配置
# ================================
domains:
  backend:
    - agentx-api.zeabur.app
  frontend:
    - agentx.zeabur.app

# ================================
# 网络配置
# ================================
networking:
  # 服务间通信
  internal:
    - backend <-> postgres
    - frontend <-> backend

  # 外部访问
  external:
    - frontend:3000
    - backend:8088
